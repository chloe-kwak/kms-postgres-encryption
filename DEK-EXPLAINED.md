# DEKλ€? (μ‰¬μ΄ μ„¤λ…)

## π“¦ DEK = Data Encryption Key (λ°μ΄ν„° μ•”νΈν™” ν‚¤)

μ‹¤μ λ΅ λ°μ΄ν„°λ¥Ό μ•”νΈν™”/λ³µνΈν™”ν•λ” λ° μ‚¬μ©ν•λ” **μ‘μ—…μ© ν‚¤**μ…λ‹λ‹¤.

---

## π”‘ λ‘ κ°€μ§€ ν‚¤μ μ—­ν• 

### 1. CMK (Customer Master Key) - λ§μ¤ν„° ν‚¤
```
μ—­ν• : ν‚¤λ¥Ό μ•”νΈν™”ν•λ” ν‚¤ (μƒμ„ ν‚¤)
μ„μΉ: AWS KMS HSM (μ λ€ μ™Έλ¶€λ΅ λ‚μ¤μ§€ μ•μ)
ν¬κΈ°: 256 bits
μλ…: μκµ¬μ  (κµμ²΄ κ°€λ¥)

λΉ„μ : κΈκ³  μ—΄μ‡ 
```

### 2. DEK (Data Encryption Key) - μ‘μ—… ν‚¤
```
μ—­ν• : μ‹¤μ  λ°μ΄ν„°λ¥Ό μ•”νΈν™”/λ³µνΈν™”ν•λ” ν‚¤ (ν•μ„ ν‚¤)
μ„μΉ: DBμ— μ €μ¥ (CMKλ΅ μ•”νΈν™”λ μƒνƒ)
ν¬κΈ°: 256 bits (AES-256)
μλ…: λ°μ΄ν„°μ™€ ν•¨κ» μ €μ¥ (λ°μ΄ν„°λ‹Ή 1κ°)

λΉ„μ : μ‚¬λ¬Όν•¨ μ—΄μ‡ 
```

---

## π—οΈ μ™ λ‘ κ°μ ν‚¤λ¥Ό μ‚¬μ©ν• κΉ?

### β λ°©μ‹ 1: CMKλ΅ μ§μ ‘ μ•”νΈν™” (μ• μΆ‹μ)

```
λ°μ΄ν„° 1 β”€β”
λ°μ΄ν„° 2 β”€β”¤
λ°μ΄ν„° 3 β”€β”Όβ”€β”€> CMKλ΅ μ§μ ‘ μ•”νΈν™”
λ°μ΄ν„° 4 β”€β”¤
...      β”€β”

λ¬Έμ μ :
β CMKλ¥Ό κ³„μ† μ‚¬μ© (μ„±λ¥ μ €ν•)
β CMK κµμ²΄ μ‹ λ¨λ“  λ°μ΄ν„° μ¬μ•”νΈν™” ν•„μ”
β 4KB ν¬κΈ° μ ν•
β KMS API λΉ„μ© λ§μ΄ λ‚κ°
```

### β… λ°©μ‹ 2: Envelope Encryption (μΆ‹μ)

```
       CMK (λ§μ¤ν„° ν‚¤)
         β”‚
         β”‚ DEKλ¥Ό μ•”νΈν™”
         β†“
       DEK (μ‘μ—… ν‚¤)
         β”‚
         β”‚ λ°μ΄ν„°λ¥Ό μ•”νΈν™”
         β†“
   μ‹¤μ  λ°μ΄ν„°λ“¤
```

**μ¥μ :**
- β… CMKλ” DEKλ§ μ•”νΈν™” (μ‚¬μ© μµμ†ν™”)
- β… DEKλ΅ λ€μ©λ‰ λ°μ΄ν„° λΉ λ¥΄κ² μ•”νΈν™”
- β… CMK κµμ²΄ν•΄λ„ λ°μ΄ν„° μ¬μ•”νΈν™” λ¶ν•„μ”
- β… ν¬κΈ° μ ν• μ—†μ
- β… λΉ„μ© μ κ°

---

## π”„ μ‹¤μ  μ‘λ™ λ°©μ‹

### μ•”νΈν™” κ³Όμ •

```
1λ‹¨κ³„: DEK μƒμ„±
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚   KMS    β”‚  GenerateDataKey API νΈμ¶
β”‚   CMK    β”‚  β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€>
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
     β”‚
     β”‚ λ°ν™:
     β”‚ - Plaintext DEK (ν‰λ¬Έ 32 bytes)
     β”‚ - Encrypted DEK (μ•”νΈν™”λ DEK)
     β†“

2λ‹¨κ³„: λ°μ΄ν„° μ•”νΈν™”
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ Plaintext DEK μ‚¬μ©   β”‚
β”‚ '123-45-6789'        β”‚  pgcryptoλ΅ μ•”νΈν™”
β”‚ β†’ 'Xp8kR3m...'       β”‚  β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€>
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”

3λ‹¨κ³„: DBμ— μ €μ¥
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ users ν…μ΄λΈ”                    β”‚
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¤
β”‚ ssn: 'Xp8kR3m...'              β”‚ μ•”νΈν™”λ λ°μ΄ν„°
β”‚ (+ Encrypted DEKλ” λ³„λ„ μ €μ¥)   β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”

4λ‹¨κ³„: ν‰λ¬Έ DEK μ‚­μ 
λ©”λ¨λ¦¬μ—μ„ μ¦‰μ‹ μ‚­μ  (λ³΄μ•!)
```

### λ³µνΈν™” κ³Όμ •

```
1λ‹¨κ³„: DBμ—μ„ κ°€μ Έμ¤κΈ°
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ users ν…μ΄λΈ”                    β”‚
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¤
β”‚ ssn: 'Xp8kR3m...'              β”‚ μ•”νΈν™”λ λ°μ΄ν„°
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ dek_store ν…μ΄λΈ”                β”‚
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¤
β”‚ encrypted_dek: 'AQIDAHj...'    β”‚ μ•”νΈν™”λ DEK
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”

2λ‹¨κ³„: DEK λ³µνΈν™”
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚   KMS    β”‚  Decrypt API νΈμ¶
β”‚   CMK    β”‚  (Encrypted DEK μ „μ†΅)
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”  β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€>
     β”‚
     β”‚ λ°ν™:
     β”‚ Plaintext DEK
     β†“

3λ‹¨κ³„: λ°μ΄ν„° λ³µνΈν™”
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ Plaintext DEK μ‚¬μ©   β”‚
β”‚ 'Xp8kR3m...'         β”‚  pgcryptoλ΅ λ³µνΈν™”
β”‚ β†’ '123-45-6789'      β”‚  β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€>
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”

4λ‹¨κ³„: ν‰λ¬Έ DEK μ‚­μ  (λλ” μΊμ‹)
λ©”λ¨λ¦¬μ—μ„ μ‚­μ  λλ” 1λ¶„κ°„ μΊμ‹
```

---

## π― μ‹¤μ  μμ‹

### μμ‹ 1: μ£Όλ―Όλ²νΈ μ•”νΈν™”

```typescript
// 1. KMSμ—μ„ DEK μƒμ„±
const { PlaintextKey, CiphertextBlob } = await kms.generateDataKey({
  KeyId: 'CMK-ARN',
  KeySpec: 'AES_256'
});

// PlaintextKey: μ‹¤μ  μ‘μ—…μ— μ‚¬μ©ν•  DEK (32 bytes)
// μ: Buffer<4a 3f 2e 1d c8 9b 7f 3a ... > (32 bytes)

// CiphertextBlob: CMKλ΅ μ•”νΈν™”λ DEK
// μ: Buffer<01 02 03 04 AQ ID AH j1 ... > (μ•”νΈν™”λ μƒνƒ)

// 2. DEKλ΅ μ£Όλ―Όλ²νΈ μ•”νΈν™”
const encrypted = encrypt('123-45-6789', PlaintextKey);
// κ²°κ³Ό: 'Xp8kR3m5Lq9...' (Base64)

// 3. DBμ— μ €μ¥
await db.insert({
  ssn: encrypted,                    // μ•”νΈν™”λ μ£Όλ―Όλ²νΈ
  encrypted_dek: CiphertextBlob      // μ•”νΈν™”λ DEK (λ³„λ„ ν…μ΄λΈ”)
});

// 4. PlaintextKey μ‚­μ 
PlaintextKey = null;  // λ©”λ¨λ¦¬μ—μ„ μ κ±°
```

### μμ‹ 2: λ³µνΈν™”

```typescript
// 1. DBμ—μ„ κ°€μ Έμ¤κΈ°
const user = await db.findOne({ id: userId });
// user.ssn = 'Xp8kR3m5Lq9...'

const encryptedDek = await db.getEncryptedDek('users_ssn_key');
// encryptedDek = Buffer<01 02 03 04 AQ ID AH j1 ... >

// 2. KMSλ΅ DEK λ³µνΈν™”
const { Plaintext } = await kms.decrypt({
  CiphertextBlob: encryptedDek
});
// Plaintext = Buffer<4a 3f 2e 1d c8 9b 7f 3a ... > (ν‰λ¬Έ DEK)

// 3. DEKλ΅ λ°μ΄ν„° λ³µνΈν™”
const ssn = decrypt(user.ssn, Plaintext);
// ssn = '123-45-6789'

// 4. Plaintext μ‚­μ  (λλ” μΊμ‹)
Plaintext = null;  // λ©”λ¨λ¦¬μ—μ„ μ κ±°
```

---

## π“ λ°μ΄ν„° κµ¬μ΅° μμ‹

### dek_store ν…μ΄λΈ” (DEK μ €μ¥μ†)

```sql
SELECT * FROM dek_store;

 key_name       | encrypted_dek                        | active
----------------+--------------------------------------+--------
 users_ssn_key  | AQIDAHj1xK8p...Rvbw== (Base64 512μ) | true
 users_cc_key   | AQIDAHj9mN2r...Qxyz== (Base64 512μ) | true
```

**μ£Όμ:** `encrypted_dek`λ” CMKλ΅ μ•”νΈν™”λ μƒνƒμ…λ‹λ‹¤!
- μ΄ κ°’λ§μΌλ΅λ” μ•„λ¬΄κ²ƒλ„ ν•  μ μ—†μ
- KMS APIλ΅λ§ λ³µνΈν™” κ°€λ¥ (IAM κ¶ν• ν•„μ”)

### temp_dek_cache ν…μ΄λΈ” (μ„Έμ… μΊμ‹)

```sql
SELECT * FROM temp_dek_cache;

 session_id | key_name      | plaintext_dek                   | expires_at
------------+---------------+---------------------------------+---------------------
 12345      | users_ssn_key | \x4a3f2e1dc89b... (32 bytes)   | 2024-02-05 10:36:00
 12345      | users_cc_key  | \x9f2c8d4e7b1a... (32 bytes)   | 2024-02-05 10:36:00
```

**μ£Όμ:** `plaintext_dek`λ” **ν‰λ¬Έ DEK**μ…λ‹λ‹¤!
- μ΄κ²ƒμ΄ λ…Έμ¶λλ©΄ ν•΄λ‹Ή ν‚¤λ΅ μ•”νΈν™”λ λ°μ΄ν„° λ³µνΈν™” κ°€λ¥
- λ”°λΌμ„ TTL 1λ¶„, UNLOGGED TABLE, μ ‘κ·Ό μ μ–΄ ν•„μ”

---

## π”’ λ³΄μ• λΉ„κµ

### λ°©μ‹ 1: DEK μ—†μ (CMK μ§μ ‘ μ‚¬μ©)

```
μ¥μ :
β… κ°€μ¥ μ•μ „ (CMKλ” μ λ€ λ…Έμ¶ μ• λ¨)

λ‹¨μ :
β λ§¤λ² KMS API νΈμ¶ (λΉ„μ© λ†’μ)
β μ„±λ¥ λλ¦Ό (100-300ms)
β 4KB ν¬κΈ° μ ν•
```

### λ°©μ‹ 2: DEK μΊμ‹±

```
μ¥μ :
β… λΉ„μ© 99% μ κ°
β… μ„±λ¥ 75λ°° λΉ λ¦„
β… ν¬κΈ° μ ν• μ—†μ

λ‹¨μ :
β οΈ ν‰λ¬Έ DEKκ°€ λ©”λ¨λ¦¬μ— 1λ¶„ μ΅΄μ¬
β οΈ DB κ΄€λ¦¬μκ°€ μ ‘κ·Ό κ°€λ¥ (μ΄λ΅ μƒ)

β†’ ν•μ§€λ§ ν†µμ  κ°€λ¥!
```

---

## π― ν•µμ‹¬ μ •λ¦¬

### DEKλ€?

```
DEK = μ‹¤μ λ΅ λ°μ΄ν„°λ¥Ό μ•”λ³µνΈν™”ν•λ” μ‘μ—…μ© ν‚¤

CMK (λ§μ¤ν„° ν‚¤, KMSμ—λ§ μ΅΄μ¬)
  β”‚
  β”‚ DEKλ¥Ό λ³΄νΈ
  β†“
DEK (μ‘μ—… ν‚¤, DBμ— μ•”νΈν™”λμ–΄ μ €μ¥)
  β”‚
  β”‚ λ°μ΄ν„°λ¥Ό μ•”λ³µνΈν™”
  β†“
μ‹¤μ  λ°μ΄ν„° (DBμ— μ•”νΈν™”λμ–΄ μ €μ¥)
```

### μ™ μ‚¬μ©?

```
1. μ„±λ¥: DEKλ΅ λΉ λ¥΄κ² μ•”λ³µνΈν™”
2. λΉ„μ©: CMK μ‚¬μ© μµμ†ν™”
3. ν™•μ¥μ„±: λ€μ©λ‰ λ°μ΄ν„° μ²λ¦¬
4. μ μ—°μ„±: CMK κµμ²΄ν•΄λ„ λ°μ΄ν„° μ¬μ•”νΈν™” λ¶ν•„μ”
```

### λ³΄μ•μ€?

```
β… DEK μμ²΄λ„ CMKλ΅ μ•”νΈν™”λμ–΄ μ €μ¥
β… CMKλ” KMS HSMμ—λ§ μ΅΄μ¬ (μ λ€ λ…Έμ¶ μ• λ¨)
β οΈ ν‰λ¬Έ DEKλ” μ‚¬μ© μ‹μ—λ§ λ©”λ¨λ¦¬μ— μ΅΄μ¬ (1λ¶„, μΊμ‹± μ‹)
β… λ””μ•„λ¨λ³΄λ‹¤ μ•μ „ (λ§μ¤ν„° ν‚¤κ°€ KMSμ— μμ)
```

---

## π’΅ λΉ„μ λ΅ μ΄ν•΄ν•κΈ°

### μ€ν–‰ κΈκ³  μ‹μ¤ν…

```
CMK = μ€ν–‰ κΈκ³  μ—΄μ‡ 
- μ€ν–‰ κΈκ³ μ‹¤μ—λ§ λ³΄κ΄€
- μ λ€ μ™Έλ¶€λ΅ λ‚κ°€μ§€ μ•μ
- μ§€μ μ¥λ§ μ ‘κ·Ό κ°€λ¥

DEK = κ° κ³ κ°μ μ‚¬λ¬Όν•¨ μ—΄μ‡ 
- μ€ν–‰ κΈκ³  μ•μ— λ³΄κ΄€
- ν•„μ”ν•  λ• κΈκ³ μ—μ„ κΊΌλ‚΄μ„ μ‚¬μ©
- μ‚¬μ© ν›„ λ‹¤μ‹ κΈκ³ μ— λ³΄κ΄€

λ°μ΄ν„° = μ‚¬λ¬Όν•¨ μ•μ λ¬Όκ±΄
- μ‚¬λ¬Όν•¨ μ—΄μ‡ (DEK)λ΅λ§ μ—΄ μ μμ
- μ‚¬λ¬Όν•¨ μ—΄μ‡ λ” μ€ν–‰ κΈκ³ (CMK)λ΅ λ³΄νΈλ¨
```

### μ‹¤μ  νλ¦„

```
1. κ³ κ°μ΄ λ¬Όκ±΄ λ§΅κΉ€
   β†’ DEK μƒμ„± (κΈκ³ μ—μ„ μƒ μ‚¬λ¬Όν•¨ μ—΄μ‡  λ°κΈ‰)
   β†’ DEKλ΅ μ‚¬λ¬Όν•¨ μ κΈ
   β†’ DEKλ¥Ό κΈκ³ μ— λ³΄κ΄€ (CMKλ΅ λ³΄νΈ)

2. κ³ κ°μ΄ λ¬Όκ±΄ μ°ΎμΌλ¬ μ΄
   β†’ κΈκ³ μ—μ„ DEK κΊΌλƒ„ (μ§€μ μ¥μ΄ CMKλ΅ κΈκ³  μ—΄μ–΄μ„)
   β†’ DEKλ΅ μ‚¬λ¬Όν•¨ μ—΄κΈ°
   β†’ λ¬Όκ±΄ λ°ν™
   β†’ DEK λ‹¤μ‹ κΈκ³ μ— λ³΄κ΄€

3. DEK μΊμ‹± = 1λ¶„κ°„ DEKλ¥Ό λ°–μ— λ‘κΈ°
   β†’ κ°™μ€ κ³ κ°μ΄ λ‹¤μ‹ μ¬ λ• λΉ λ¥΄κ² μ²λ¦¬
   β†’ 1λ¶„ μ§€λ‚λ©΄ μλ™μΌλ΅ κΈκ³ μ— λ³΄κ΄€
```

---

## β“ μμ£Ό λ¬»λ” μ§λ¬Έ

### Q1: DEKλ¥Ό DBμ— ν‰λ¬ΈμΌλ΅ μ €μ¥ν•λ©΄ μ• λλ‚μ”?

**A:** μ λ€ μ• λ©λ‹λ‹¤! β
```
ν‰λ¬Έ DEK μ €μ¥ μ‹:
- DB λ°±μ—… νƒμ·¨ β†’ λ¨λ“  λ°μ΄ν„° λ³µνΈν™” κ°€λ¥
- DB κ΄€λ¦¬μκ°€ DEK μ¶”μ¶ β†’ λ¬΄μ ν• μ ‘κ·Ό

CMKλ΅ μ•”νΈν™”ν•μ—¬ μ €μ¥ μ‹:
- DB λ°±μ—… νƒμ·¨ν•΄λ„ KMS κ¶ν• μ—†μΌλ©΄ λ¬΄μ©μ§€λ¬Ό
- KMS IAM μ •μ±…μΌλ΅ μ ‘κ·Ό μ μ–΄
```

### Q2: μΊμ‹μ— ν‰λ¬Έ DEKκ°€ μλ”λ° μ•μ „ν•κ°€μ”?

**A:** μ ν•μ μΌλ΅ μ•μ „ν•©λ‹λ‹¤ β οΈ
```
μ„ν—:
- λ©”λ¨λ¦¬ λ¤ν”„ μ‹ λ…Έμ¶ κ°€λ¥
- DB κ΄€λ¦¬μκ°€ μ΅°ν κ°€λ¥ (μ΄λ΅ μƒ)

μ™„ν™”μ±…:
β… UNLOGGED TABLE (λ°±μ—… λ¶ν¬ν•¨)
β… TTL 1λ¶„ (λ…Έμ¶ μ‹κ°„ μµμ†)
β… SECURITY DEFINER (μ§μ ‘ μ ‘κ·Ό μ°¨λ‹¨)
β… κ°μ‚¬ λ΅κ·Έ (λ¨λ“  μ ‘κ·Ό κΈ°λ΅)

β†’ λ””μ•„λ¨λ³΄λ‹¤λ” μ•μ „ (λ§μ¤ν„° ν‚¤κ°€ KMSμ— μμ)
```

### Q3: λ§¤λ² KMS νΈμ¶ vs DEK μΊμ‹± λ­κ°€ λ‚μ•„μ”?

**A:** μ”κµ¬μ‚¬ν•­μ— λ”°λΌ λ‹¤λ¦…λ‹λ‹¤
```
κΈμµ/μλ£ (μµκ³  λ³΄μ•):
β†’ λ§¤λ² KMS νΈμ¶
β†’ λΉ„μ©: $14/μ›”, λ³΄μ•: 10/10

μΌλ° μ„λΉ„μ¤:
β†’ DEK μΊμ‹±
β†’ λΉ„μ©: $0.29/μ›” (98% μ κ°), λ³΄μ•: 8/10
```

---

**DEKλ” μ„±λ¥κ³Ό λ³΄μ•μ κ· ν•μ„ λ§μ¶”κΈ° μ„ν• μ‘μ—…μ© ν‚¤μ…λ‹λ‹¤!** π”‘
